{% extends "base.html" %}

{% block title %}إنشاء حساب - شلبي فيرس{% endblock %}

{% block header %}إنشاء حساب جديد{% endblock %}
{% block subtitle %}انضم إلى منصتنا الآمنة{% endblock %}

{% block content %}
<form method="POST" novalidate>
    {{ form.hidden_tag() }}
    
    <div class="form-group">
        {{ form.username.label(class="form-label") }}
        <i class="input-icon fas fa-user"></i>
        {{ form.username(class="form-input" + (" error" if form.username.errors else ""), placeholder="أدخل اسم المستخدم") }}
        {% if form.username.errors %}
            {% for error in form.username.errors %}
                <span class="error-message">{{ error }}</span>
            {% endfor %}
        {% endif %}
    </div>

    <div class="form-group">
        {{ form.email.label(class="form-label") }}
        <i class="input-icon fas fa-envelope"></i>
        {{ form.email(class="form-input" + (" error" if form.email.errors else ""), placeholder="أدخل عنوان البريد الإلكتروني") }}
        {% if form.email.errors %}
            {% for error in form.email.errors %}
                <span class="error-message">{{ error }}</span>
            {% endfor %}
        {% endif %}
    </div>

    <div class="form-group">
        {{ form.password.label(class="form-label") }}
        <i class="input-icon fas fa-lock"></i>
        {{ form.password(class="form-input" + (" error" if form.password.errors else ""), placeholder="أنشئ كلمة مرور قوية") }}
        {% if form.password.errors %}
            {% for error in form.password.errors %}
                <span class="error-message">{{ error }}</span>
            {% endfor %}
        {% endif %}
    </div>

    <div class="form-group">
        {{ form.password2.label(class="form-label") }}
        <i class="input-icon fas fa-lock"></i>
        {{ form.password2(class="form-input" + (" error" if form.password2.errors else ""), placeholder="أكد كلمة المرور") }}
        {% if form.password2.errors %}
            {% for error in form.password2.errors %}
                <span class="error-message">{{ error }}</span>
            {% endfor %}
        {% endif %}
    </div>

    <div class="form-group">
        {{ form.submit(class="submit-btn") }}
    </div>
</form>

<div class="auth-links">
    <p>لديك حساب بالفعل؟ <a href="{{ url_for('login') }}">سجل دخولك هنا</a></p>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .form-label {
        color: var(--neutral-charcoal);
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .password-strength {
        margin-top: 0.5rem;
        font-size: 0.8rem;
    }

    .strength-weak { color: var(--error-red); }
    .strength-medium { color: var(--warning-yellow); }
    .strength-strong { color: var(--success-green); }

    .password-requirements {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--deep-sapphire);
        opacity: 0.7;
    }

    .password-requirements ul {
        margin: 0.25rem 0 0 1rem;
        padding: 0;
    }

    .password-requirements li {
        margin-bottom: 0.2rem;
    }

    .requirement-met {
        color: var(--success-green);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('password2');
    
    if (passwordInput) {
        // Add password strength indicator
        const strengthDiv = document.createElement('div');
        strengthDiv.className = 'password-strength';
        passwordInput.parentElement.appendChild(strengthDiv);
        
        // Add password requirements
        const requirementsDiv = document.createElement('div');
        requirementsDiv.className = 'password-requirements';
        requirementsDiv.innerHTML = `
            <ul>
                <li id="req-length">At least 8 characters</li>
                <li id="req-uppercase">One uppercase letter</li>
                <li id="req-lowercase">One lowercase letter</li>
                <li id="req-number">One number</li>
            </ul>
        `;
        passwordInput.parentElement.appendChild(requirementsDiv);
        
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const strength = checkPasswordStrength(password);
            
            // Update strength indicator
            strengthDiv.textContent = `Password strength: ${strength.text}`;
            strengthDiv.className = `password-strength strength-${strength.level}`;
            
            // Update requirements
            updateRequirements(password);
        });
    }
    
    if (confirmPasswordInput && passwordInput) {
        confirmPasswordInput.addEventListener('input', function() {
            if (this.value && this.value !== passwordInput.value) {
                this.classList.add('error');
                showPasswordMismatch();
            } else {
                this.classList.remove('error');
                hidePasswordMismatch();
            }
        });
    }
    
    function checkPasswordStrength(password) {
        let score = 0;
        
        if (password.length >= 8) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/[a-z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[^A-Za-z0-9]/.test(password)) score++;
        
        if (score < 2) return { level: 'weak', text: 'Weak' };
        if (score < 4) return { level: 'medium', text: 'Medium' };
        return { level: 'strong', text: 'Strong' };
    }
    
    function updateRequirements(password) {
        const requirements = [
            { id: 'req-length', test: password.length >= 8 },
            { id: 'req-uppercase', test: /[A-Z]/.test(password) },
            { id: 'req-lowercase', test: /[a-z]/.test(password) },
            { id: 'req-number', test: /[0-9]/.test(password) }
        ];
        
        requirements.forEach(req => {
            const element = document.getElementById(req.id);
            if (element) {
                element.className = req.test ? 'requirement-met' : '';
            }
        });
    }
    
    function showPasswordMismatch() {
        let errorSpan = confirmPasswordInput.parentElement.querySelector('.password-mismatch');
        if (!errorSpan) {
            errorSpan = document.createElement('span');
            errorSpan.className = 'error-message password-mismatch';
            errorSpan.textContent = 'Passwords do not match';
            confirmPasswordInput.parentElement.appendChild(errorSpan);
        }
    }
    
    function hidePasswordMismatch() {
        const errorSpan = confirmPasswordInput.parentElement.querySelector('.password-mismatch');
        if (errorSpan) {
            errorSpan.remove();
        }
    }
});
</script>
{% endblock %}